df_base
df_base %>%
gather(package,time,-npixels,-pixel_size) %>%
ggplot(aes(x=npixels,y=time,color=package))+
geom_line()+
geom_point()
fig_06 <- df_base
save(fig_01, fig_02, fig_03, fig_04, fig_05, fig_06,file = '/home/aybarpc01/Github/csaybar.github.io/data/post01.Rdata')
save(fig_01, fig_02, file = '/home/aybarpc01/Github/csaybar.github.io/data/post01.Rdata')
save(fig_01, fig_02, file = '/home/aybarpc01/Github/csaybar.github.io/data/post01.Rdata')
fig_01
fig_02
save(fig_02, file = '/home/aybarpc01/Github/csaybar.github.io/data/post01.Rdata')
save(fig_01, file = '/home/aybarpc01/Github/csaybar.github.io/data/post01.Rdata')
save(fig_02, fig_03, fig_04, fig_05, fig_06,file = '/home/aybarpc01/Github/csaybar.github.io/data/post01.Rdata')
levelplot(clim_stack[[1:4]],
main='PISCOp Climatological Precipitation',
margin=T,
colorkey=list(
labels=list(at=range, font=4),
axis.line=list(col='black')
),
col.regions=palette,
at=range) +
layer(sp.polygons(sud_sp,col = rgb(1, 1, 1, 0.4), lwd=1))
levelplot(clim_stack[[1:4]],
main='PISCOp Climatological Precipitation',
margin=T,
colorkey=list(
labels=list(at=range, font=4),
axis.line=list(col='black')
),
col.regions=palette,
at=range) +
layer(sp.polygons(sud_sp,col = rgb(1, 1, 1, 0.4), lwd=1))
save(clim_stack,file = '/home/aybarpc01/Github/csaybar.github.io/data/post01.Rdata')
```{r viz, message = FALSE, echo=TRUE,fig.width=5,fig.height=5}
fig_01 <- clim_stack
fig_02
fig_03 <- list(rr = clim_1_a[[1]]*1, arequipa)
fig_04 <- list(rr = clim_1_b[[1]]*1, arequipa)
fig_05 <- list(rr = clim_1_c[[1]]*1, arequipa)
fig_06 <- df_base
save(fig_01, fig_02, fig_03, fig_04, fig_05, fig_06,file = '/home/aybarpc01/Github/csaybar.github.io/data/post01.Rdata')
fig_01
file.size(fig_01)
save(fig_01,file = '/home/aybarpc01/Github/csaybar.github.io/data/post01.Rdata')
fig_06
fig_02
fig_03
fig_04
fig_05
fig_05
save(fig_06,file = '/home/aybarpc01/Github/csaybar.github.io/data/post01.Rdata')
save(fig_01, fig_02, fig_03, fig_04, fig_05, fig_06,file = '/home/aybarpc01/Github/csaybar.github.io/data/post01.Rdata')
load('/home/aybarpc01/Github/csaybar.github.io/data/post01.Rdata')
fig_01
fig_02
fig_03
fig_04
fig_05
fig_06
figures <- fig_01, fig_02, fig_03, fig_04, fig_05, fig_06
figures <- list(fig_01, fig_02, fig_03, fig_04, fig_05, fig_06)
figures
save(figures,file = '/home/aybarpc01/Github/csaybar.github.io/data/post01.Rdata')
object.size(fig_01)
object.size(fig_01)/1024
figures
save(fig_01,file = '/home/aybarpc01/Github/csaybar.github.io/data/post01.Rdata')
save(fig_02,file = '/home/aybarpc01/Github/csaybar.github.io/data/post01.Rdata')
save(fig_03,file = '/home/aybarpc01/Github/csaybar.github.io/data/post01.Rdata')
fig_03
fig_04
fig_02
save(fig_02,file = '/home/aybarpc01/Github/csaybar.github.io/data/post01.Rdata')
save(fig_03,file = '/home/aybarpc01/Github/csaybar.github.io/data/post01.Rdata')
fig_03
fig_02
fig_04
save(fig_04,file = '/home/aybarpc01/Github/csaybar.github.io/data/post01.Rdata')
save(fig_05,file = '/home/aybarpc01/Github/csaybar.github.io/data/post01.Rdata')
raster_base <- crop(clim_stack[[1]], arequipa)
res(raster_base) <- 0.05
clim_1_a <- raster::resample(clim_stack,
raster_base,
method='bilinear')
clim_1_a
fig_03 <- list(rr = clim_1_a[[1]]*1, shp = arequipa)
fig_03
save(fig_03,file = '/home/aybarpc01/Github/csaybar.github.io/data/post01.Rdata')
clim_1_b <- names(clim_stack) %>%
map(~ gdal_resample(clim_stack[[.x]],raster_base)) %>%
stack()
fig_04 <- list(rr = clim_1_b[[1]]*1, shp = arequipa)
fig_04
save(fig_04,file = '/home/aybarpc01/Github/csaybar.github.io/data/post01.Rdata')
fig_05 <- df_base
df_base
fig_04 <- list(rr = clim_1_b[[1]]*1, shp = arequipa)
fig_05 <- list(rr = clim_1_c[[1]]*1, shp = arequipa)
save(fig_05,file = '/home/aybarpc01/Github/csaybar.github.io/data/post01.Rdata')
message(sprintf('%s \n',system('lscpu',intern = T)))
plan(multiprocess)
clim_1_c <- names(clim_stack) %>%
future_map(~ gdal_resample(clim_stack[[.x]],raster_base)) %>%
stack()
plot(clim_1_c[[1]], main = 'Jan Precipitation in Arequipa')
fig_05 <- list(rr = clim_1_c[[1]]*1, shp = arequipa)
save(fig_05,file = '/home/aybarpc01/Github/csaybar.github.io/data/post01.Rdata')
fig_06 <- df_base
figures <- list(fig_01, fig_02, fig_03, fig_04, fig_05, fig_06)
fig_02
fig_01
save(fig_01,file = '/home/aybarpc01/Github/csaybar.github.io/data/post01.Rdata')
fig_01[[1]]
round(fig_01,2)
save(round(fig_01,2),file = '/home/aybarpc01/Github/csaybar.github.io/data/post01.Rdata')
round(fig_01,2)
ddd = round(fig_01,2)
save(ddd,file = '/home/aybarpc01/Github/csaybar.github.io/data/post01.Rdata')
ddd = round(fig_01,1)
save(ddd,file = '/home/aybarpc01/Github/csaybar.github.io/data/post01.Rdata')
fig_01
dataType(fig_01)
dataType(fig_01) <- INT2S
dataType(fig_01) <- 'INT2S'
save(fig_01,file = '/home/aybarpc01/Github/csaybar.github.io/data/post01.Rdata')
fig_01
round(fig_01,2)
round(fig_01,0)
dssad = round(fig_01,0)
save(dssad,file = '/home/aybarpc01/Github/csaybar.github.io/data/post01.Rdata')
ssd = fig_01
storage.mode(ssd[]) = "integer"
ssd
save(ssd,file = '/home/aybarpc01/Github/csaybar.github.io/data/post01.Rdata')
fig_01
fig_01
clim_stack_integer <- clim_stack*10
storage.mode(clim_stack_integer[]) = "integer"
clim_stack_integer
plot(clim_stack_integer[[1]])
plot(clim_stack_integer[[1]]/10)
clim_stack_integer/10
levelplot(clim_stack_integer/10,
main='PISCOp Climatological Precipitation',
margin=T,
colorkey=list(
labels=list(at=range, font=4),
axis.line=list(col='black')
),
col.regions=palette,
at=range) +
layer(sp.polygons(sud_sp,col = rgb(1, 1, 1, 0.4), lwd=1))
unlink('content/post/resample_cache', recursive = TRUE)
library('ggplot2')
library('plotly')
library('cptcity')
library('rasterVis')
library('mapview')
library('kableExtra')
library('gdalUtils')
library('sf')
library('raster')
library('purrr') # ex girlfriend
library('furrr') # new girlfriend
library('tidyverse')
user <- 'publi_dgh2' # ftp user
pass <- '123456'   # ftp user
ftp <- 'ftp.senamhi.gob.pe/PISCOp_V2.1_beta/' # url
dir <- 'PISCOp_climatology/PISCOp_climatology/' # urn
months <- sprintf('%02d',1:12) # GEOtiff names
clim_stack <- stack(tmp_files) %>%
'names<-'(month.abb) %>% '*'(1) # change the RasterLayer names
ftp_n <- mapply(download.file, clim,tmp_files,quiet = TRUE)
clim_stack <- stack(tmp_files) %>%
'names<-'(month.abb) %>% '*'(1) # change the RasterLayer names
clim_stack[clim_stack <= 0] <- 0
storage.mode(clim_stack[]) = "integer" #round to an integer
mapply(file.remove, tmp_files)
webpage_github <- 'https://github.com/csaybar/csaybar.github.io/'
file <- 'raw/master/data/post01.zip'
link <- sprintf('%s%s', webpage_github, file)
fn <- sprintf('%s.zip', tempfile())
download.file(link,fn)
td <- tempdir()
unzip(fn, ex = td)
name_sud <- sprintf('%s/sud_peru_2.shp', td)
sud_sp <- st_read(name_sud, quiet = TRUE) %>% as('Spatial')
palette <- cpt('ukmo_wow_humidity')
range <- seq(0,800,100)
clim_stack
levelplot(clim_stack,
main='PISCOp Climatological Precipitation',
margin=T,
colorkey=list(
labels=list(at=range, font=4),
axis.line=list(col='black')
),
col.regions=palette,
at=range) +
layer(sp.polygons(sud_sp,col = rgb(1, 1, 1, 0.4), lwd=1))
# Creating a polygon of the PISCOp extent
piscop_extent <- clim_stack[[1]] %>%
extent %>%
raster(nrows=1,ncols=1) %>%
as('SpatialPolygons') %>%
st_as_sf()
piscop_extent$NOMBRE = 'PISCOp extent'
name_arq <- sprintf('%s/arequipa_simply.shp', td)
arequipa <- st_read(name_arq, quiet = TRUE) %>% as('Spatial')
m_01 <- mapview(arequipa)
m_02 <- mapview(piscop_extent, fill=NA)
fig_02 <- m_01 + m_02
fig_02
raster_base <- crop(clim_stack_integer[[1]], arequipa)
res(raster_base) <- 0.05
clim_1_a <- raster::resample(clim_stack_integer/10,
raster_base,
method='bilinear')
fig_03 <- list(rr = clim_1_a[[1]]*1, shp = arequipa)
clim_1_a
#'
#' @param r Raster* object to be resampled
#' @param r_base Raster* object with parameters that r
#' should be resampled to.
#' @param method Character. GDAL resampling_method
#' ("near"|"bilinear"|"cubic"|"cubicspline"|
#'  "lanczos"|"average"|"mode"|"max"|"min"|
#'  "med"|"q1"|"q3")
#'
#' @export
gdal_resample <- function(r,r_base,method='bilinear') {
#Geometry attributes
t1 <- c(xmin(r_base), ymin(r_base),
xmax(r_base), ymax(r_base))
res <- res(r_base)
#Temporal files
tmp_outname <- sprintf('%s.tif',tempfile())
tmp_inname <- sprintf('%s.tif',tempfile())
writeRaster(r,tmp_inname)
#GDAL time!
gdalwarp(tmp_inname,tmp_outname,tr=res,te=t1,r = method)
resample_raster = raster(tmp_outname)
return(resample_raster)
}
clim_1_b <- names(clim_stack) %>%
map(~ gdal_resample(clim_stack[[.x]],raster_base)) %>%
stack()
fig_04 <- list(rr = clim_1_b[[1]]*1, shp = arequipa)
message(sprintf('%s \n',system('lscpu',intern = T)))
plan(multiprocess)
clim_1_c <- names(clim_stack) %>%
future_map(~ gdal_resample(clim_stack[[.x]],raster_base)) %>%
stack()
fig_05 <- list(rr = clim_1_c[[1]]*1, shp = arequipa)
cell_size <- c(0.05, 0.025, 0.01, 0.005, 0.0025, 0.00175, 0.001)
for(x in cell_size) {
raster_base <- crop(clim_stack[[1]], arequipa)
res(raster_base) <- x
time_m01 <- system.time(
clim_1_a <- resample(clim_stack[[1:4]],
raster_base,
method='bilinear'))
time_m02 <- system.time(
clim_1_b <- names(clim_stack)[1:4] %>%
map(~ gdal_resample(clim_stack[[.x]],raster_base)) %>%
stack())
time_m03 <- system.time(
clim_1_c <- names(clim_stack)[1:4] %>%
future_map(~ gdal_resample(clim_stack[[.x]],
raster_base)) %>%
stack())
df_size <- data_frame(
pixel_size = x,
npixels = ncell(clim_1_a)*12,
raster = time_m01[3],
gdalUtils = time_m02[3],
gdalUtils_4par = time_m03[3]
)
if (x == 0.05) {
df_base <- df_size
} else {
df_base <- bind_rows(df_base, df_size)
}
}
df_base %>%
gather(package,time,-npixels,-pixel_size) %>%
ggplot(aes(x=npixels,y=time,color=package))+
geom_line()+
geom_point()
cell_size <- c(0.05, 0.025, 0.01, 0.005, 0.0025, 0.00175, 0.0015 , 0.001)
for(x in cell_size) {
raster_base <- crop(clim_stack[[1]], arequipa)
res(raster_base) <- x
time_m01 <- system.time(
clim_1_a <- resample(clim_stack[[1:4]],
raster_base,
method='bilinear'))
time_m02 <- system.time(
clim_1_b <- names(clim_stack)[1:4] %>%
map(~ gdal_resample(clim_stack[[.x]],raster_base)) %>%
stack())
time_m03 <- system.time(
clim_1_c <- names(clim_stack)[1:4] %>%
future_map(~ gdal_resample(clim_stack[[.x]],
raster_base)) %>%
stack())
df_size <- data_frame(
pixel_size = x,
npixels = ncell(clim_1_a)*12,
raster = time_m01[3],
gdalUtils = time_m02[3],
gdalUtils_4par = time_m03[3]
)
if (x == 0.05) {
df_base <- df_size
} else {
df_base <- bind_rows(df_base, df_size)
}
}
df_base %>%
gather(package,time,-npixels,-pixel_size) %>%
ggplot(aes(x=npixels,y=time,color=package))+
geom_line()+
geom_point()
fig_06 <- df_base
figures <- list(fig_01, fig_02, fig_03, fig_04, fig_05, fig_06)
save(figures,file = '/home/aybarpc01/Github/csaybar.github.io/data/post01.Rdata')
blogdown::build_site()
load('data/post01.Rdata')
load('/home/aybarpc01/Github/csaybar.github.io/data/post01.Rdata')
figures <- list(
fig_01 = fig_01,
fig_02 = fig_02,
fig_03 = fig_03,
fig_04 = fig_04,
fig_05 = fig_05,
fig_06 = fig_06
)
save(figures,file = '/home/aybarpc01/Github/csaybar.github.io/data/post01.Rdata')
load('/home/aybarpc01/Github/csaybar.github.io/data/post01.Rdata')
blogdown::build_site()
blogdown::build_site()
kable(df_base)
kable(df_base)
blogdown::build_site()
blogdown::build_site()
blogdown::build_site()
blogdown::build_site()
blogdown::build_site()
blogdown::build_site()
blogdown::build_site()
blogdown::build_site()
kable(df_base)%>%
kable_styling(bootstrap_options = "striped",
full_width = F)
blogdown::build_site()
blogdown::build_site()
plot_ly (
x =
c(
1,
2, 3 ),
y =
c(
5,
6,
7),
type = ‘scatter’ ,
mode = ‘lines’
)
plot_ly (
x =
c(
1,
2, 3 ),
y =
c(
5,
6,
7),
type = ‘scatter’ ,
mode = ‘lines’
)
plot_ly (x =c(1,2, 3 ),
y = c(5,6,7),
type = 'scatter' ,
mode = 'lines'
)
library(plotly)
trace_0 <- rnorm(100, mean = 5)
trace_1 <- rnorm(100, mean = 0)
trace_2 <- rnorm(100, mean = -5)
x <- c(1:100)
data <- data.frame(x, trace_0, trace_1, trace_2)
p <- plot_ly(data, x = ~x) %>%
add_trace(y = ~trace_0, name = 'trace 0',mode = 'lines') %>%
add_trace(y = ~trace_1, name = 'trace 1', mode = 'lines+markers') %>%
add_trace(y = ~trace_2, name = 'trace 2', mode = 'markers')
p
df_base
df_base %>%  plot_ly(x=~npixels) %>%
add_trace(y = ~raster, name = 'trace 0',mode = 'lines') %>%
add_trace(y = ~gdalUtils, name = 'trace 1', mode = 'lines+markers') %>%
add_trace(y = ~gdalUtils_4par, name = 'trace 2', mode = 'markers')
df_base %>%  plot_ly(x=~npixels) %>%
add_trace(y = ~raster, name = 'trace 0',mode = 'lines+markers') %>%
add_trace(y = ~gdalUtils, name = 'trace 1', mode = 'lines+markers') %>%
add_trace(y = ~gdalUtils_4par, name = 'trace 2', mode = 'lines+markers')
df_base %>%  plot_ly(x=~npixels) %>%
add_trace(y = ~raster, name = 'raster',mode = 'lines+markers') %>%
add_trace(y = ~gdalUtils, name = 'GdalUtils', mode = 'lines+markers') %>%
add_trace(y = ~gdalUtils_4par, name = 'GdalUtils_par', mode = 'lines+markers')
df_base
df_base %>%  plot_ly(x=~npixels) %>%
add_trace(y = ~raster, name = 'raster',mode = 'lines+markers') %>%
add_trace(y = ~gdalUtils, name = 'GdalUtils', mode = 'lines+markers') %>%
add_trace(y = ~gdalUtils_4par, name = 'GdalUtils_par', mode = 'lines+markers')
df_base %>%  plot_ly(x=~npixels) %>%
add_trace(y = ~raster, name = 'raster',
mode = 'lines+markers') %>%
add_trace(y = ~gdalUtils, name = 'GdalUtils',
mode = 'lines+markers') %>%
add_trace(y = ~gdalUtils_4par, name = 'GdalUtils_par',
mode = 'lines+markers')
blogdown::build_site()
df_base %>%  plot_ly(x=~log1p(npixels)) %>%
add_trace(y = ~raster, name = 'raster',
mode = 'lines+markers') %>%
add_trace(y = ~gdalUtils, name = 'GdalUtils',
mode = 'lines+markers') %>%
add_trace(y = ~gdalUtils_4par, name = 'GdalUtils_par',
mode = 'lines+markers')
df_base %>%  plot_ly(x=~npixels,
xaxis = list(type = "log")) %>%
add_trace(y = ~raster, name = 'raster',
mode = 'lines+markers') %>%
add_trace(y = ~gdalUtils, name = 'GdalUtils',
mode = 'lines+markers') %>%
add_trace(y = ~gdalUtils_4par, name = 'GdalUtils_par',
mode = 'lines+markers')
df_base %>%  plot_ly(x=~npixels) %>%
add_trace(y = ~raster, name = 'raster',
mode = 'lines+markers') %>%
add_trace(y = ~gdalUtils, name = 'GdalUtils',
mode = 'lines+markers') %>%
add_trace(y = ~gdalUtils_4par, name = 'GdalUtils_par',
mode = 'lines+markers')
df_base %>%  plot_ly(x=~npixels,
xaxis = list(type = "log")) %>%
add_trace(y = ~raster, name = 'raster',
mode = 'lines+markers')
df_base %>%  plot_ly(x=~npixels) %>%
add_trace(y = ~raster, name = 'raster',
xaxis = list(type = "log"),
mode = 'lines+markers')
df_base %>%  plot_ly(x=~npixels) %>%
add_trace(y = ~raster, name = 'raster',
mode = 'lines+markers') %>%
add_trace(y = ~gdalUtils, name = 'GdalUtils',
mode = 'lines+markers') %>%
add_trace(y = ~gdalUtils_4par, name = 'GdalUtils_par',
mode = 'lines+markers')
df_base %>%  plot_ly(x=~npixels) %>%
add_trace(y = ~raster, name = 'raster',
mode = 'lines+markers') %>%
add_trace(y = ~gdalUtils, name = 'GdalUtils',
mode = 'lines+markers') %>%
add_trace(y = ~gdalUtils_4par, name = 'GdalUtils_par',
mode = 'lines+markers') %>%
layout(xaxis = list(type = "log"))
df_base %>%  plot_ly(x=~npixels) %>%
add_trace(y = ~raster, name = 'raster',
mode = 'lines+markers') %>%
add_trace(y = ~gdalUtils, name = 'GdalUtils',
mode = 'lines+markers') %>%
add_trace(y = ~gdalUtils_4par, name = 'GdalUtils_par',
mode = 'lines+markers') %>%
layout(xaxis = list(type = "log",title = 'time (s)'))
df_base %>%  plot_ly(x=~npixels) %>%
add_trace(y = ~raster, name = 'raster',
mode = 'lines+markers') %>%
add_trace(y = ~gdalUtils, name = 'GdalUtils',
mode = 'lines+markers') %>%
add_trace(y = ~gdalUtils_4par, name = 'GdalUtils_par',
mode = 'lines+markers') %>%
layout(xaxis = list(type = "log",title = 'time (s)'))
df_base %>%  plot_ly(x=~npixels) %>%
add_trace(y = ~raster, name = 'raster',
mode = 'lines+markers') %>%
add_trace(y = ~gdalUtils, name = 'GdalUtils',
mode = 'lines+markers') %>%
add_trace(y = ~gdalUtils_4par, name = 'GdalUtils_par',
mode = 'lines+markers') %>%
layout(xaxis = list(type = "log"))
df_base %>%  plot_ly(x=~npixels) %>%
add_trace(y = ~raster, name = 'raster',
mode = 'lines+markers') %>%
add_trace(y = ~gdalUtils, name = 'GdalUtils',
mode = 'lines+markers') %>%
add_trace(y = ~gdalUtils_4par, name = 'GdalUtils_par',
mode = 'lines+markers') %>%
layout(xaxis = list(type = "log",title = 'nPixels'),
yaxis = list(title = 'time (s)')
)
load('data/post01.Rdata')
setwd('/home/aybarpc01/Github/csaybar.github.io/')
setwd('/home/aybarpc01/Github/csaybar.github.io/')
load('data/post01.Rdata')
setwd('/home/aybarpc01/Github/csaybar.github.io/')
