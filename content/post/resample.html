---
title: "Raster resampling in R"
author: "Cesar Aybar"
date: '2018-12-05'
output:
  html_document:
    toc: true
    toc_float: true
---



<div id="intro" class="section level2">
<h2>1. Intro</h2>
<p>A typical workflow for earth analysts always will have to do with several spatial data sources (e.g. Sentinel, MODIS and Landsat) each one with a particular extent and pixel resolution. <strong>Resampling</strong> is the technique used to <em>homogenize</em> these spatial attributes.</p>
<div class="figure">
<img src="http://desktop.arcgis.com/en/arcmap/latest/extensions/spatial-analyst/performing-analysis/GUID-F4B313D5-9585-4687-B5EE-37E9C9243EBE-web.png" alt="Image obtained from here" />
<p class="caption">Image obtained from <a href="http://desktop.arcgis.com/en/arcmap/latest/extensions/spatial-analyst/performing-analysis/cell-size-and-resampling-in-analysis.htm">here</a></p>
</div>
<p>This post demonstrate how easy and incredibly fast is resampling gridded data in R using the <a href="https://cran.r-project.org/web/packages/raster/index.html">raster</a> and <a href="https://cran.r-project.org/web/packages/gdalUtils/index.html">gdalUtils</a> packages. If you do not familiarize with they , first, look at this <a href="https://geoscripting-wur.github.io/IntroToRaster/">tutorial</a> or run in R:</p>
<pre class="r"><code>vignette(&quot;functions&quot;, package = &quot;raster&quot;) # Run me in R!</code></pre>
<p>While <code>raster</code> package allow to perform fast operation thanks to optimized back-end C code, some raster manipulation techniques such as <code>raster::resample()</code> can become incredibly slow as the raster size increase. A effective alternative but a little more complicated to code is use a <strong>wrapper library</strong> (gdalUtils).</p>
</div>
<div id="wrapper-libraries" class="section level2">
<h2>2. Wrapper libraries</h2>
<p>In few words, a <em>wrapper</em> library (not confuse with a binding library) is a piece of code which translate a library’s existing (e.g GDAL) into a different interface (e.g an R package). The main advantage is that you will use GDAL in its original language (C++). Check it <a href="https://stackoverflow.com/questions/8628326/what-is-the-difference-between-a-wrapper-bindings-and-a-port">this</a> for a more comprehensible explanation.</p>
</div>
<div id="demo" class="section level2">
<h2>3. Demo</h2>
<p>Get the climatological gridded rainfall dataset <a href="http://ons.snirh.gob.pe/Peru/maproom/Monitoring/Meteorological/PISCO-Prec-v20.pdf">PISCOpclim</a> (~10 km) for <a href="https://en.wikipedia.org/wiki/Arequipa_Region">Arequipa</a> and change the pixel size to ~0.5 km.</p>
<p><strong>Before coding do not forget install and load the packages!</strong></p>
<pre class="r"><code>library(&#39;raster&#39;)
library(&#39;ggplot2&#39;)
library(&#39;gdalUtils&#39;)
library(&#39;rasterVis&#39;)
library(&#39;sf&#39;)
library(&#39;kableExtra&#39;)
library(&#39;mapview&#39;)
library(&#39;future&#39;)
library(&#39;purrr&#39;) # ex girlfriend
library(&#39;furrr&#39;) # new girlfriend
library(&#39;tidyverse&#39;)</code></pre>
<div id="downloading-piscopclim" class="section level3">
<h3>3.1 Downloading PISCOpclim</h3>
<pre class="r"><code>user &lt;- &#39;publi_dgh2&#39; # ftp user 
pass &lt;- &#39;123456&#39;   # ftp user
ftp &lt;- &#39;ftp.senamhi.gob.pe/PISCOp_V2.1_beta/&#39; # url
dir &lt;- &#39;PISCOp_climatology/PISCOp_climatology/&#39; # urn
months &lt;- sprintf(&#39;%02d&#39;,1:12) # GEOtiff names
clim &lt;- sprintf(&#39;ftp://%s:%s@%s%s%s.tif&#39;, user, pass, ftp, dir,months)

ftp_n &lt;- mapply(download.file, clim,basename(clim),quiet = TRUE)</code></pre>
</div>
<div id="creating-a-rasterstack" class="section level3">
<h3>3.2 Creating a rasterStack</h3>
<pre class="r"><code>clim_stack &lt;- stack(basename(clim)) %&gt;% 
  &#39;names&lt;-&#39;(month.abb) # change the RasterLayer names

cols &lt;- brewer.pal(11, &quot;RdBu&quot;) #palette
range &lt;- seq(-1, 800, 100) # Precipitation range
levelplot(clim_stack, par.settings=GrTheme(),at=range)</code></pre>
</div>
<div id="arequipa-region" class="section level3">
<h3>3.3 Arequipa Region</h3>
<pre class="r"><code># Creating a polygon of the PISCOp extent
piscop_extent &lt;- clim_stack[[1]] %&gt;% 
                  extent %&gt;% 
                  raster(nrows=1,ncols=1) %&gt;% 
                  as(&#39;SpatialPolygons&#39;) %&gt;% 
                  st_as_sf()

piscop_extent$NOMBRE = &#39;PISCOp extent&#39;

arequipa &lt;- st_read(&#39;arequipa_simply.shp&#39;, quiet = TRUE)
m_01 &lt;- mapview(arequipa)
m_02 &lt;- mapview(piscop_extent, fill=NA)

m_01 + m_02</code></pre>
</div>
<div id="method-01-resampling-via-raster-package" class="section level3">
<h3>3.4 Method 01: Resampling via <code>raster</code> package</h3>
<pre class="r"><code>raster_base &lt;- crop(clim_stack[[1]], arequipa)
res(raster_base) &lt;- 0.05

system.time(
clim_1_a &lt;- resample(clim_stack,raster_base,method=&#39;bilinear&#39;)
)

plot(clim_1_a[[1]], main = &#39;Jan Precipitation in Arequipa&#39;)
plot(as(arequipa,&#39;Spatial&#39;),add=T)</code></pre>
</div>
<div id="method-02-resampling-via-gdalutils-package" class="section level3">
<h3>3.5 Method 02: Resampling via <code>gdalUtils</code> package</h3>
<pre class="r"><code>#&#39; Resampling a Raster* object via GDAL
#&#39; 
#&#39; @param r Raster* object to be resampled
#&#39; @param r_base Raster* object with parameters that r
#&#39; should be resampled to.
#&#39; @param method Character. GDAL resampling_method
#&#39; (&quot;near&quot;|&quot;bilinear&quot;|&quot;cubic&quot;|&quot;cubicspline&quot;|
#&#39;  &quot;lanczos&quot;|&quot;average&quot;|&quot;mode&quot;|&quot;max&quot;|&quot;min&quot;|
#&#39;  &quot;med&quot;|&quot;q1&quot;|&quot;q3&quot;)
#&#39;
#&#39; @export
gdal_resample &lt;- function(r,r_base,method=&#39;bilinear&#39;) {
  
  #Geometry attributes
  t1 &lt;- c(xmin(r_base), ymin(r_base), 
          xmax(r_base), ymax(r_base))
  res &lt;- res(r_base)
  
  #Temporal files
  tmp_outname &lt;- sprintf(&#39;%s.tif&#39;,tempfile())
  tmp_inname &lt;- sprintf(&#39;%s.tif&#39;,tempfile())
  writeRaster(r,tmp_inname)
  
  #GDAL time!
  gdalwarp(tmp_inname,tmp_outname,tr=res,te=t1,r = method)
  resample_raster = raster(tmp_outname)
  mapply(file.remove,c(tmp_inname,tmp_outname))
  return(resample_raster)
}</code></pre>
<p><strong>Sequential approach</strong></p>
<pre class="r"><code>system.time(
clim_1_b &lt;- names(clim_stack) %&gt;% 
  map(~ gdal_resample(clim_stack[[.x]],raster_base)) %&gt;%
  stack()
)

plot(clim_1_a[[1]], main = &#39;Jan Precipitation in Arequipa&#39;)
plot(as(arequipa,&#39;Spatial&#39;),add=T)</code></pre>
<p><strong>Multiprocess approach</strong></p>
<pre class="r"><code>message(sprintf(&#39;%s \n&#39;,system(&#39;lscpu&#39;,intern = T)))</code></pre>
<pre class="r"><code>plan(multiprocess)</code></pre>
<pre class="r"><code>system.time(
clim_1_b &lt;- names(clim_stack) %&gt;% 
  future_map(~ gdal_resample(clim_stack[[.x]],raster_base)) %&gt;%
  stack()
)
plot(clim_1_a[[1]], main = &#39;Jan Precipitation in Arequipa&#39;)
plot(as(arequipa,&#39;Spatial&#39;),add=T)</code></pre>
</div>
</div>
<div id="raster-vs-gdalutils-comparison-simple-benckmark" class="section level2">
<h2>raster vs gdalUtils Comparison (Simple Benckmark)</h2>
<pre class="r"><code>cell_size &lt;- c(0.05,0.025,0.01,0.005,0.0025,0.001)


for(x in cell_size) { 
  
  raster_base &lt;- crop(clim_stack[[1]], arequipa)
  res(raster_base) &lt;- x

  time_m01 &lt;- system.time(
    clim_1_a &lt;- resample(clim_stack[[1:4]],
                         raster_base,
                         method=&#39;bilinear&#39;))

  time_m02 &lt;- system.time(
    clim_1_b &lt;- names(clim_stack)[1:4] %&gt;% 
      map(~ gdal_resample(clim_stack[[.x]],raster_base)) %&gt;%
      stack())

  time_m03 &lt;- system.time(
    clim_1_c &lt;- names(clim_stack)[1:4] %&gt;% 
      future_map(~ gdal_resample(clim_stack[[.x]],
                                 raster_base)) %&gt;%
      stack())
  
  df_size &lt;- data_frame(
    pixel_size = x,
    npixels = ncell(clim_1_a)*12,
    raster = time_m01[3],
    gdalUtils = time_m02[3],
    gdalUtils_4par = time_m03[3]
  )
  if (x == 0.05) {
    df_base &lt;- df_size
  } else {
    df_base &lt;- bind_rows(df_base, df_size)
  }
}</code></pre>
<pre class="r"><code>kable(df_base)
df_base %&gt;%
  gather(package,time,-npixels,-pixel_size) %&gt;% 
  ggplot(aes(x=npixels,y=time,color=package))+
  geom_line()+
  geom_point()</code></pre>
</div>
